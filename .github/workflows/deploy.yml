name: Deploy on push

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (for completeness, not used on remote)
        uses: actions/checkout@v4

      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: Deploy to droplet
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT || '22' }}
          # Must match bot systemd WorkingDirectory/ExecStart path on the server (see bot_polya.service)
          WORKDIR: ${{ secrets.WORKDIR || '/opt/bot' }}
        run: |
          set -euo pipefail
          ssh -o StrictHostKeyChecking=no -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" "
            set -e
            cd \"$WORKDIR\"
            echo '--- deploy context ---'
            echo \"WORKDIR=$WORKDIR\"
            pwd
            ls -la | head -n 80
            echo '--- systemd unit (effective) ---'
            systemctl show -p FragmentPath,DropInPaths,WorkingDirectory,ExecStart bot_polya || true
            systemctl cat bot_polya --no-pager || true
            echo '--- git repo check ---'
            test -d .git || (echo 'ERROR: WORKDIR is not a git repo (no .git). Check WORKDIR secret vs server path.' && exit 2)
            git pull --rebase
            echo '--- server repo ---'
            pwd
            export GIT_SHA=$(git rev-parse --short HEAD)
            echo \"GIT_SHA=$GIT_SHA\"
            echo '--- write GIT_SHA into .env (for /version) ---'
            touch .env
            (grep -v '^GIT_SHA=' .env || true; echo \"GIT_SHA=$GIT_SHA\") > .env.tmp
            mv .env.tmp .env
            git log -1 --oneline
            echo '--- precheck systemd ---'
            whoami
            systemctl is-active bot_polya || true
            echo '--- update deps ---'
            \"$WORKDIR/venv/bin/python\" -m pip install -r requirements.txt
            echo '--- restart bot ---'
            systemctl restart bot_polya
            systemctl status bot_polya --no-pager | head -n 60
            echo '--- recent logs (journalctl) ---'
            journalctl -u bot_polya -n 120 --no-pager || true
            echo '--- process check ---'
            ps -ef | grep bot_polya.py | grep -v grep || true
          "

